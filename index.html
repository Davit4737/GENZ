<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Local Trading Journal — Full (Offline)</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#071220; --panel:#0b1622; --muted:#9fb0bb; --accent:#28c7a9; --danger:#ff6b6b;
  --card-radius:10px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background:linear-gradient(180deg,#041021,#071428); color:#e6f0f6; padding:16px;
}
.wrapper{display:grid;grid-template-columns:360px 1fr;gap:16px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.h-left{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7b61ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#052;}
.title{font-size:18px;font-weight:700}
.small{color:var(--muted);font-size:13px}

/* left panel */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:12px; border-radius:var(--card-radius);}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.form-row > *{flex:1}
input[type="text"],input[type="number"],input[type="date"],select,textarea{
  width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.04);
  background:transparent; color:inherit; font-size:13px;
}
button{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#022;cursor:pointer}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.small-btn{padding:6px 8px;font-size:13px;border-radius:6px}

/* center */
.main{display:flex;flex-direction:column;gap:12px}
.top-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.filter-row{display:flex;gap:8px;align-items:center}
.table-card{overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{padding:10px;text-align:left;color:var(--muted);border-bottom:1px dashed rgba(255,255,255,0.03)}
tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
.badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:12px}

/* stats & charts */
.stats{display:flex;gap:8px}
.stat{flex:1;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)}
canvas{width:100%!important;height:220px!important;background:transparent}

/* footer */
.footer{color:var(--muted);font-size:12px;text-align:center;margin-top:8px}

/* responsive */
@media(max-width:1000px){
  .wrapper{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="header">
  <div class="h-left">
    <div class="logo">TJ</div>
    <div>
      <div class="title">Local Trading Journal — Full</div>
      <div class="small">Офлайн. Добавление/Импорт/Экспорт/Аналитика по неделям/месяцам.</div>
    </div>
  </div>
  <div>
    <button id="exportCSV">Экспорт CSV</button>
    <button id="importBtn" class="ghost">Импорт CSV</button>
    <input type="file" id="importFile" accept=".csv" style="display:none">
    <button id="resetAll" class="small-btn ghost" title="Очистить все данные">Сброс</button>
  </div>
</div>

<div class="wrapper">

  <!-- LEFT: form -->
  <aside>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Добавить / Редактировать сделку</div>
        <div class="small">Локально</div>
      </div>

      <form id="tradeForm">
        <input type="hidden" id="tradeId" value="">
        <div class="form-row">
          <div>
            <label class="small">Символ</label>
            <input id="symbol" type="text" placeholder="BTCUSDT">
          </div>
          <div>
            <label class="small">Тип</label>
            <select id="side">
              <option value="LONG">LONG</option>
              <option value="SHORT">SHORT</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label class="small">Цена входа</label>
            <input id="entry" type="number" step="any">
          </div>
          <div>
            <label class="small">Цена выхода</label>
            <input id="exit" type="number" step="any">
          </div>
        </div>

        <div class="form-row">
          <div>
            <label class="small">Лоты / Количество</label>
            <input id="size" type="number" step="any" value="1">
          </div>
          <div>
            <label class="small">Комиссия (в $)</label>
            <input id="commission" type="number" step="any" value="0">
          </div>
        </div>

        <div class="form-row">
          <div style="flex:1">
            <label class="small">Дата</label>
            <input id="date" type="date">
          </div>
          <div style="width:120px">
            <label class="small">Валюта P/L</label>
            <select id="plCurrency">
              <option value="USD">USD</option>
              <option value="USDT">USDT</option>
            </select>
          </div>
        </div>

        <div style="margin-bottom:8px">
          <label class="small">Заметка</label>
          <textarea id="notes" rows="3" style="width:100%;border-radius:6px;padding:8px;border:1px solid rgba(255,255,255,0.04)"></textarea>
        </div>

        <div style="display:flex;gap:8px">
          <button type="submit">Сохранить</button>
          <button type="button" id="clearForm" class="ghost">Очистить форму</button>
        </div>
      </form>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">Фильтры / Просмотр</div>
      <div class="form-row">
        <input id="filterSymbol" type="text" placeholder="фильтр по символу">
        <select id="filterSide">
          <option value="">Все</option><option value="LONG">LONG</option><option value="SHORT">SHORT</option>
        </select>
      </div>
      <div class="form-row">
        <input id="filterFrom" type="date">
        <input id="filterTo" type="date">
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="applyFilters" class="small-btn">Применить</button>
        <button id="resetFilters" class="small-btn ghost">Сбросить</button>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">Quick stats</div>
      <div id="quickStats" class="small">
        Сделок: 0<br>Общий P/L: 0<br>Win rate: 0%
      </div>
    </div>

  </aside>

  <!-- MAIN: table + charts -->
  <main class="main">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Сделки</div>
        <div class="small">Импорт/Экспорт CSV | Данные в localStorage</div>
      </div>

      <div class="table-card">
        <table id="tradesTable" role="table" aria-label="Trades table">
          <thead>
            <tr>
              <th>Дата</th><th>Символ</th><th>Тип</th><th>Entry</th><th>Exit</th><th>Size</th><th>Комм.$</th><th>P/L</th><th>%</th><th>Note</th><th>Действия</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>

    <div style="display:flex;gap:12px">
      <div class="stat">
        <div style="font-weight:700">Equity Curve</div>
        <canvas id="equityChart"></canvas>
      </div>
      <div class="stat">
        <div style="font-weight:700">P/L per week</div>
        <canvas id="weeklyChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Агрегаты</div>
        <div class="small">Сгруппировано по неделям / месяцам</div>
      </div>
      <div id="aggrArea" style="margin-top:8px" class="small"></div>
    </div>

    <div class="footer">Сохранение локально — файл не покидает твой компьютер. Никаких серверов.</div>
  </main>

</div>

<script>
// -----------------------------
// Utilities
// -----------------------------
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
function fmtNum(n){ return (Math.round(n*100)/100).toLocaleString('en'); }
function parseDateISO(s){ if(!s) return null; const d=new Date(s); if(isNaN(d)) return null; return d; }
function startOfWeek(date){ const d=new Date(date); const day=d.getDay(); const diff=d.getDate() - day + (day===0?-6:1); return new Date(d.setDate(diff)); } // Monday
function isoDate(d){ if(!d) return ''; const dt=new Date(d); const y=dt.getFullYear(); const m=('0'+(dt.getMonth()+1)).slice(-2); const dd=('0'+dt.getDate()).slice(-2); return `${y}-${m}-${dd}`; }
function weekKey(d){ const s = startOfWeek(new Date(d)); return isoDate(s); }
function monthKey(d){ const dt=new Date(d); return dt.getFullYear() + '-' + ('0'+(dt.getMonth()+1)).slice(-2); }

// -----------------------------
// Storage
// -----------------------------
const STORAGE_KEY = 'local_trades_v1';
let trades = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

// -----------------------------
// DOM refs
// -----------------------------
const tbody = document.querySelector('#tradesTable tbody');
const form = document.getElementById('tradeForm');
const tradeIdInput = document.getElementById('tradeId');
const inputs = {
  symbol: document.getElementById('symbol'),
  side: document.getElementById('side'),
  entry: document.getElementById('entry'),
  exit: document.getElementById('exit'),
  size: document.getElementById('size'),
  commission: document.getElementById('commission'),
  date: document.getElementById('date'),
  notes: document.getElementById('notes'),
  plCurrency: document.getElementById('plCurrency')
};
const quickStats = document.getElementById('quickStats');

// filters
const filterSymbol = document.getElementById('filterSymbol');
const filterSide = document.getElementById('filterSide');
const filterFrom = document.getElementById('filterFrom');
const filterTo = document.getElementById('filterTo');
const applyFilters = document.getElementById('applyFilters');
const resetFilters = document.getElementById('resetFilters');

// import/export
const exportCSVBtn = document.getElementById('exportCSV');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const resetAllBtn = document.getElementById('resetAll');

// charts
let equityChart=null, weeklyChart=null;

// -----------------------------
// Core calculations
// -----------------------------
function calcTradePL(t){
  // pl = (exit - entry) * size (for long), reversed for short. subtract commission.
  // If trade has explicit pl value (legacy) use it; but here compute.
  const entry = Number(t.entry)||0;
  const exit = Number(t.exit)||0;
  const size = Number(t.size)||1;
  const commission = Number(t.commission)||0;
  let pl;
  if(t.side === 'LONG') pl = (exit - entry) * size - commission;
  else pl = (entry - exit) * size - commission;
  const plp = entry!==0 ? (pl / (entry * size) * 100) : 0;
  return {pl: +pl.toFixed(2), plp: +plp.toFixed(2)};
}

function saveAll(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(trades));
}

// -----------------------------
// Rendering
// -----------------------------
function renderTable(filtered=null){
  const list = filtered || trades.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
  tbody.innerHTML = '';
  list.forEach(t=>{
    const {pl,plp} = calcTradePL(t);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.date}</td>
      <td>${t.symbol}</td>
      <td><span class="badge">${t.side}</span></td>
      <td>${t.entry}</td>
      <td>${t.exit}</td>
      <td>${t.size}</td>
      <td>${t.commission}</td>
      <td style="color:${pl>=0?'#9df7c7':'#ff9b9b'}">${pl>=0? '+'+fmtNum(pl):fmtNum(pl)}</td>
      <td>${plp}%</td>
      <td>${(t.notes||'')}</td>
      <td>
        <button class="small-btn" data-id="${t.id}" onclick="editTrade(event)">Edit</button>
        <button class="small-btn ghost" data-id="${t.id}" onclick="deleteTrade(event)">Del</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  updateStats(filtered);
  renderCharts(filtered);
  renderAggregates(filtered);
}

function updateStats(filtered=null){
  const list = filtered || trades;
  let total=0, wins=0;
  list.forEach(t=>{
    const {pl} = calcTradePL(t);
    total += pl;
    if(pl>0) wins++;
  });
  const wr = list.length ? Math.round((wins/list.length)*10000)/100 : 0;
  quickStats.innerHTML = `Сделок: ${list.length}<br>Общий P/L: ${fmtNum(total)} ${list[0]?.plCurrency || 'USD'}<br>Win rate: ${wr}%`;
}

// -----------------------------
// Charts
// -----------------------------
function renderCharts(filtered=null){
  const list = (filtered || trades).slice().sort((a,b)=> new Date(a.date) - new Date(b.date));
  // equity
  let labels = [], data = [];
  let cum=0;
  list.forEach(t=>{
    const {pl} = calcTradePL(t);
    cum += pl;
    labels.push(t.date);
    data.push(Math.round(cum*100)/100);
  });
  if(!labels.length){ labels = ['-']; data=[0]; }
  // equityChart
  const eqCtx = document.getElementById('equityChart').getContext('2d');
  if(equityChart) equityChart.destroy();
  equityChart = new Chart(eqCtx, {
    type:'line',
    data:{labels, datasets:[{label:'Equity', data, borderColor: '#28c7a9', backgroundColor:'rgba(40,199,169,0.08)', tension:0.2}]},
    options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:false}}}
  });

  // weekly aggregation
  const weekMap = {};
  list.forEach(t=>{
    const wk = weekKey(t.date);
    const {pl} = calcTradePL(t);
    weekMap[wk] = (weekMap[wk]||0) + pl;
  });
  const weekLabels = Object.keys(weekMap).sort();
  const weekData = weekLabels.map(k=>Math.round(weekMap[k]*100)/100);
  const wkCtx = document.getElementById('weeklyChart').getContext('2d');
  if(weeklyChart) weeklyChart.destroy();
  weeklyChart = new Chart(wkCtx, {
    type:'bar',
    data:{labels:weekLabels, datasets:[{label:'P/L per week', data:weekData, backgroundColor: weekData.map(v=> v>=0? 'rgba(40,199,169,0.6)':'rgba(255,107,107,0.6)')}]},
    options:{plugins:{legend:{display:false}}, scales:{x:{ticks:{maxRotation:45,minRotation:0}}}}
  });
}

// -----------------------------
// Aggregates (weekly/monthly)
function renderAggregates(filtered=null){
  const list = (filtered || trades);
  const wk = {}; const mo = {};
  list.forEach(t=>{
    const {pl} = calcTradePL(t);
    const w = weekKey(t.date);
    const m = monthKey(t.date);
    wk[w] = (wk[w]||0) + pl;
    mo[m] = (mo[m]||0) + pl;
  });
  // render top 8 weeks and months
  let html = '<div style="display:flex;gap:12px;flex-wrap:wrap">';
  html += '<div style="flex:1"><b>По неделям</b><br>';
  const weekKeys = Object.keys(wk).sort().reverse();
  weekKeys.slice(0,8).forEach(k=> html += `${k}: ${ (wk[k]>=0? '+' : '') + fmtNum(wk[k]) }<br>`);
  html += '</div>';
  html += '<div style="flex:1"><b>По месяцам</b><br>';
  const monKeys = Object.keys(mo).sort().reverse();
  monKeys.slice(0,8).forEach(k=> html += `${k}: ${ (mo[k]>=0? '+' : '') + fmtNum(mo[k]) }<br>`);
  html += '</div></div>';
  document.getElementById('aggrArea').innerHTML = html;
}

// -----------------------------
// CRUD
// -----------------------------
form.addEventListener('submit', (e)=>{
  e.preventDefault();
  const id = tradeIdInput.value || uid();
  const t = {
    id,
    symbol: inputs.symbol.value.trim() || 'N/A',
    side: inputs.side.value,
    entry: parseFloat(inputs.entry.value) || 0,
    exit: parseFloat(inputs.exit.value) || 0,
    size: parseFloat(inputs.size.value) || 1,
    commission: parseFloat(inputs.commission.value) || 0,
    date: inputs.date.value || isoDate(new Date()),
    notes: inputs.notes.value || '',
    plCurrency: inputs.plCurrency.value || 'USD'
  };
  const existing = trades.findIndex(x=>x.id===id);
  if(existing>=0) trades[existing] = t; else trades.push(t);
  saveAll();
  renderTable();
  form.reset();
  tradeIdInput.value='';
});

window.editTrade = function(e){
  const id = e.target.dataset.id;
  const t = trades.find(x=>x.id===id);
  if(!t) return alert('Trade not found');
  tradeIdInput.value = t.id;
  inputs.symbol.value = t.symbol;
  inputs.side.value = t.side;
  inputs.entry.value = t.entry;
  inputs.exit.value = t.exit;
  inputs.size.value = t.size;
  inputs.commission.value = t.commission;
  inputs.date.value = t.date;
  inputs.notes.value = t.notes;
  inputs.plCurrency.value = t.plCurrency || 'USD';
  window.scrollTo({top:0,behavior:'smooth'});
};

window.deleteTrade = function(e){
  const id = e.target.dataset.id;
  if(!confirm('Удалить сделку?')) return;
  trades = trades.filter(x=>x.id!==id);
  saveAll();
  renderTable();
};

// -----------------------------
// Filters
// -----------------------------
applyFilters.addEventListener('click', ()=>{
  const sym = filterSymbol.value.trim().toLowerCase();
  const side = filterSide.value;
  const from = filterFrom.value ? new Date(filterFrom.value) : null;
  const to = filterTo.value ? new Date(filterTo.value) : null;
  const filtered = trades.filter(t=>{
    if(sym && !t.symbol.toLowerCase().includes(sym)) return false;
    if(side && t.side !== side) return false;
    const d = new Date(t.date);
    if(from && d < from) return false;
    if(to && d > to) return false;
    return true;
  });
  renderTable(filtered);
});
resetFilters.addEventListener('click', ()=>{
  filterSymbol.value=''; filterSide.value=''; filterFrom.value=''; filterTo.value='';
  renderTable();
});

// -----------------------------
// Import / Export CSV
// -----------------------------
function toCSV(arr){
  // header
  const hdr = ['id','date','symbol','side','entry','exit','size','commission','notes','plCurrency'];
  const rows = [hdr.join(',')];
  arr.forEach(t=>{
    const vals = hdr.map(k => {
      let v = t[k]===undefined ? '' : String(t[k]);
      if(v.includes(',')) v = `"${v.replace(/"/g,'""')}"`;
      return v;
    });
    rows.push(vals.join(','));
  });
  return rows.join('\n');
}

exportCSVBtn.addEventListener('click', ()=>{
  if(!trades.length) return alert('Нет сделок для экспорта');
  const csv = toCSV(trades);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'trades_export.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const text = e.target.result;
    const parsed = parseCSV(text);
    // Map and append, but avoid id collisions
    parsed.forEach(r=>{
      if(!r.id) r.id = uid();
      trades.push(r);
    });
    saveAll(); renderTable();
    alert('Импорт завершён: ' + parsed.length + ' строк(и)');
  };
  reader.readAsText(f);
  importFile.value = '';
});

function parseCSV(text){
  // minimal CSV parser (handles quotes)
  const lines = text.split(/\r?\n/).filter(l=>l.trim()!=='');
  if(!lines.length) return [];
  const headers = parseCSVLine(lines[0]);
  const out = [];
  for(let i=1;i<lines.length;i++){
    const vals = parseCSVLine(lines[i]);
    if(vals.length===0) continue;
    const obj = {};
    headers.forEach((h,idx)=> obj[h]= vals[idx] || '');
    // cast numeric fields
    obj.entry = parseFloat(obj.entry) || 0;
    obj.exit = parseFloat(obj.exit) || 0;
    obj.size = parseFloat(obj.size) || 1;
    obj.commission = parseFloat(obj.commission) || 0;
    out.push(obj);
  }
  return out;
}

function parseCSVLine(line){
  const res=[]; let cur=''; let inQuotes=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(inQuotes){
      if(ch==='\"'){ if(line[i+1]==='\"'){ cur+='"'; i++; } else inQuotes=false; }
      else cur+=ch;
    } else {
      if(ch===','){ res.push(cur); cur=''; }
      else if(ch==='\"'){ inQuotes=true; }
      else cur+=ch;
    }
  }
  res.push(cur);
  return res.map(s=>s.trim());
}

// -----------------------------
// Reset all
resetAllBtn.addEventListener('click', ()=>{
  if(!confirm('Вы точно хотите очистить все данные из localStorage?')) return;
  trades = []; saveAll(); renderTable();
});

// -----------------------------
// Init with sample data if empty
function seedIfEmpty(){
  if(trades.length) return;
  trades = [
    { id: uid(), date: isoDate(new Date()), symbol:'BTCUSDT', side:'LONG', entry:42000, exit:42350, size:0.1, commission:1.5, notes:'sample scalp', plCurrency:'USD' },
    { id: uid(), date: isoDate(new Date(Date.now()-86400000*2)), symbol:'AAPL', side:'SHORT', entry:170, exit:165, size:10, commission:1, notes:'earnings fade', plCurrency:'USD' },
    { id: uid(), date: isoDate(new Date(Date.now()-86400000*8)), symbol:'ETHUSDT', side:'LONG', entry:2400, exit:2600, size:0.5, commission:0.5, notes:'swing', plCurrency:'USD' },
  ];
  saveAll();
}

seedIfEmpty();
renderTable();

// -----------------------------
// Accessibility: expose functions to window for inline onclick
window.editTrade = editTrade;
window.deleteTrade = deleteTrade;

</script>

</body>
</html>
