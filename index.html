<!-- MOBILE FIX: robust tap handlers + fallback floating Buy button -->
<style>
  /* повышаем приоритет клика для кнопок Buy на мобильных */
  .btn { position: relative; z-index: 1000; -webkit-tap-highlight-color: rgba(0,0,0,0.0); }
  /* плавающая кнопка (фолбэк) */
  #mobileFallbackBuy {
    display: none;
    position: fixed;
    right: 14px;
    bottom: 18px;
    z-index: 12000;
    background: linear-gradient(135deg,#ffd60a,#ffb300);
    color:#071025;
    padding: 12px 14px;
    border-radius: 14px;
    font-weight:800;
    box-shadow: 0 8px 30px rgba(0,0,0,0.45);
    border: none;
  }
  @media(max-width:900px){
    #mobileFallbackBuy { display: inline-flex; align-items:center; gap:8px; }
  }
</style>

<button id="mobileFallbackBuy" aria-hidden="false" type="button">Buy</button>

<script>
(function(){
  // helper to add touch/click handlers reliably
  function addTap(el, handler){
    if(!el) return;
    // prevent duplicate
    if (el.__tap_installed) return;
    el.__tap_installed = true;

    const wrapped = function(e){
      try{ e.preventDefault(); e.stopPropagation(); }catch(err){}
      handler(e);
    };

    // Non-passive so preventDefault works on touchend on mobile browsers that respect passive option
    try {
      el.addEventListener('touchend', wrapped, {passive:false});
    } catch (err) {
      // older browsers
      el.addEventListener('touchend', wrapped, false);
    }
    el.addEventListener('pointerup', wrapped, {passive:false});
    el.addEventListener('click', wrapped, {passive:false});
  }

  // Ensure buttons are visible & clickable: bump z-index & pointerEvents
  ['seedBuy','earlyBuy','publicBuy','navBuy'].forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.style.position = 'relative';
      el.style.zIndex = 1000;
      el.style.pointerEvents = 'auto';
    }
  });

  // Primary handlers: openBuyModal with correct tier
  const tierMap = { seedBuy:'seed', earlyBuy:'early', publicBuy:'public' };
  Object.keys(tierMap).forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    addTap(el, function(ev){
      // defensive: ensure function exists
      if (typeof openBuyModal === 'function') openBuyModal({ autoTier: tierMap[id] });
      else {
        // fallback: scroll to buy block
        const target = document.getElementById('buy');
        if(target) target.scrollIntoView({behavior:'smooth', block:'center'});
      }
    });
  });

  // nav Buy
  const navBuy = document.getElementById('navBuy');
  if (navBuy) addTap(navBuy, function(ev){
    if (typeof openBuyModal === 'function') openBuyModal({ autoTier: null });
    else {
      const target = document.getElementById('buy');
      if(target) target.scrollIntoView({behavior:'smooth', block:'center'});
    }
  });

  // Fallback floating buy on mobile
  const mobileBtn = document.getElementById('mobileFallbackBuy');
  addTap(mobileBtn, function(){
    if (typeof openBuyModal === 'function') openBuyModal({ autoTier: null });
    else {
      const target = document.getElementById('buy');
      if(target) target.scrollIntoView({behavior:'smooth', block:'center'});
    }
  });

  // Extra failsafe: delegate touchend on document to catch taps that might be swallowed by overlays.
  // If user taps near where a Buy button is, attempt to open modal based on coordinates.
  document.addEventListener('touchend', function(e){
    // only if no modal currently open
    if (document.getElementById('__genz_modal')) return;
    const touch = (e.changedTouches && e.changedTouches[0]) || null;
    if(!touch) return;
    const x = touch.clientX, y = touch.clientY;
    // check if touch landed inside a Buy button bounding rect even if event didn't target it
    ['seedBuy','earlyBuy','publicBuy','navBuy'].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      const r = el.getBoundingClientRect();
      // pad the rect a bit (10px) to be more tolerant
      if (x >= r.left-10 && x <= r.right+10 && y >= r.top-10 && y <= r.bottom+10){
        // simulate tap
        if (typeof openBuyModal === 'function') {
          openBuyModal({ autoTier: (id==='navBuy' ? null : (id==='seedBuy'?'seed': id==='earlyBuy'?'early':'public')) });
        } else {
          const target = document.getElementById('buy');
          if(target) target.scrollIntoView({behavior:'smooth', block:'center'});
        }
      }
    });
  }, {passive:true});

  // small console hint
  console.log('Mobile tap handlers installed. If Buy still not opening — пришли модель телефона/браузера, я дам точную правку.');
})();
</script>
